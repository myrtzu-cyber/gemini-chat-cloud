<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrar Conversas - Gemini Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #654321, #8b4513);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            color: #d4af37;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid #d4af37;
        }
        button {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #654321;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: rgba(0, 255, 0, 0.2); color: #90EE90; }
        .error { background: rgba(255, 0, 0, 0.2); color: #FFB6C1; }
        .info { background: rgba(0, 123, 255, 0.2); color: #87CEEB; }
        .chat-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .chat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #d4af37;
        }
        .chat-title {
            font-weight: bold;
            color: #d4af37;
        }
        .chat-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Migra√ß√£o de Conversas</h1>
        <p>Esta ferramenta migra suas conversas do localStorage (desktop) para o banco SQLite compartilhado com o mobile.</p>
        
        <div class="section">
            <h3>üìä Status das Conversas</h3>
            <button onclick="checkLocalStorage()">Verificar localStorage</button>
            <button onclick="checkDatabase()">Verificar Banco SQLite</button>
            <div id="statusInfo" class="status info" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h3>üì± Conversas no localStorage (Desktop)</h3>
            <div id="localChats" class="chat-list"></div>
        </div>
        
        <div class="section">
            <h3>üóÑÔ∏è Conversas no Banco SQLite (Mobile)</h3>
            <div id="dbChats" class="chat-list"></div>
        </div>
        
        <div class="section">
            <h3>üöÄ Migra√ß√£o</h3>
            <button onclick="migrateChats()" class="migrate-btn">
                Migrar Conversas para SQLite
            </button>
            
            <div style="margin-top: 20px; padding: 20px; background: #2a2a2a; border-radius: 8px;">
                <h3>üìÑ Importar Conversa de Arquivo TXT</h3>
                <p>Cole o conte√∫do da conversa em um dos formatos suportados:</p>
                
                <div style="margin: 10px 0;">
                    <strong>Formato 1 - Com prefixos:</strong>
                    <pre style="background: #1a1a1a; padding: 10px; border-radius: 4px; font-size: 12px;">
User: Sua pergunta aqui
Assistant: Resposta do Gemini aqui
User: Pr√≥xima pergunta
Assistant: Pr√≥xima resposta
                    </pre>
                </div>
                
                <div style="margin: 10px 0;">
                    <strong>Formato 2 - Com separadores de texto:</strong>
                    <pre style="background: #1a1a1a; padding: 10px; border-radius: 4px; font-size: 12px;">
Gemini
Mensagem do Gemini aqui
Eu
Minha mensagem aqui
Gemini
Pr√≥xima mensagem do Gemini
                    </pre>
                    <small style="color: #ccc;">* Use "Gemini" e "Eu" como separadores (sem problemas de Unicode)</small>
                </div>
                <textarea id="txtContent" placeholder="Cole o conte√∫do da conversa aqui..." 
                    style="width: 100%; height: 200px; margin: 10px 0; padding: 10px; background: #1a1a1a; color: white; border: 1px solid #444; border-radius: 4px;"></textarea>
                <input type="text" id="chatTitle" placeholder="T√≠tulo da conversa" 
                    style="width: 100%; margin: 10px 0; padding: 10px; background: #1a1a1a; color: white; border: 1px solid #444; border-radius: 4px;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="importFromTxt()" class="migrate-btn">
                        Importar Completa
                    </button>
                    <button onclick="importFromTxtInChunks()" class="migrate-btn" style="background: linear-gradient(145deg, #4CAF50, #45a049);">
                        Importar em Partes
                    </button>
                </div>
                <small style="color: #ccc; margin-top: 10px; display: block;">
                    ‚Ä¢ <strong>Completa:</strong> Tenta importar tudo de uma vez (at√© 50MB)<br>
                    ‚Ä¢ <strong>Em Partes:</strong> Divide em conversas menores (recomendado para textos grandes)
                </small>
            </div>
            <div id="migrationStatus" class="status" style="display: none;"></div>
        </div>
    </div>

    <script>
        let localStorageChats = [];
        let databaseChats = [];
        const serverUrl = 'http://192.168.0.109:8000';

        async function checkLocalStorage() {
            localStorageChats = [];
            
            // Buscar por diferentes padr√µes de chave
            const allKeys = Object.keys(localStorage);
            console.log('Todas as chaves no localStorage:', allKeys);
            
            const chatKeys = allKeys.filter(key => 
                key.startsWith('chat_') || 
                key.startsWith('conversation_') || 
                key.includes('chat') || 
                key.includes('conversation') ||
                key === 'gemini_saved_chats'
            );
            
            console.log('Chaves de chat encontradas:', chatKeys);
            
            // Primeiro verificar gemini_saved_chats
            const saved = localStorage.getItem('gemini_saved_chats');
            if (saved) {
                try {
                    const savedChats = JSON.parse(saved);
                    if (Array.isArray(savedChats)) {
                        localStorageChats.push(...savedChats);
                    }
                } catch (error) {
                    console.error('Erro ao carregar gemini_saved_chats:', error);
                }
            }
            
            // Depois verificar outras chaves
            for (const key of chatKeys) {
                if (key === 'gemini_saved_chats') continue; // J√° processado
                
                try {
                    const chatData = JSON.parse(localStorage.getItem(key));
                    console.log(`Chat carregado ${key}:`, chatData);
                    
                    // Verificar se tem estrutura de conversa v√°lida
                    if (chatData && (chatData.conversationHistory || chatData.messages || chatData.title)) {
                        localStorageChats.push({
                            ...chatData,
                            storageKey: key // Manter refer√™ncia da chave original
                        });
                    }
                } catch (error) {
                    console.error(`Erro ao carregar chat ${key}:`, error);
                }
            }
            
            console.log('Total de conversas v√°lidas no localStorage:', localStorageChats.length);
            
            const localChatsDiv = document.getElementById('localChats');
            if (localStorageChats.length === 0) {
                localChatsDiv.innerHTML = '<p>Nenhuma conversa encontrada no localStorage</p>';
            } else {
                localChatsDiv.innerHTML = localStorageChats.map(chat => `
                    <div class="chat-item">
                        <div class="chat-title">${chat.title || 'Sem t√≠tulo'}</div>
                        <div class="chat-info">
                            ${chat.conversationHistory?.length || 0} mensagens | 
                            Criado: ${chat.createdAt ? new Date(chat.createdAt).toLocaleString() : 'Data desconhecida'}
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('migrateBtn').disabled = localStorageChats.length === 0;
            showStatus('statusInfo', `Encontradas ${localStorageChats.length} conversas no localStorage`, 'info');
        }

        async function loadDatabaseChats() {
            try {
                const response = await fetch(`${serverUrl}/api/chats`);
                if (response.ok) {
                    databaseChats = await response.json();
                    
                    const dbChatsDiv = document.getElementById('dbChats');
                    if (databaseChats.length === 0) {
                        dbChatsDiv.innerHTML = '<p>Nenhuma conversa encontrada no banco SQLite</p>';
                    } else {
                        dbChatsDiv.innerHTML = databaseChats.map(chat => `
                            <div class="chat-item">
                                <div class="chat-title">${chat.title || 'Sem t√≠tulo'}</div>
                                <div class="chat-info">
                                    ${chat.message_count || 0} mensagens | 
                                    Atualizado: ${new Date(chat.updated_at).toLocaleString()}
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    showStatus('statusInfo', `Encontradas ${databaseChats.length} conversas no banco SQLite`, 'info');
                } else {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                document.getElementById('dbChats').innerHTML = '<p>Erro ao conectar com o banco SQLite</p>';
                showStatus('statusInfo', `Erro: ${error.message}`, 'error');
            }
        }

        async function migrateChats() {
            if (localStorageChats.length === 0) {
                showStatus('migrationStatus', 'Nenhuma conversa para migrar', 'error');
                return;
            }

            showStatus('migrationStatus', 'Iniciando migra√ß√£o...', 'info');
            let migrated = 0;
            let errors = 0;

            for (const chat of localStorageChats) {
                try {
                    console.log('Migrando conversa:', chat);
                    
                    // Converter formato localStorage para formato SQLite
                    let messages = [];
                    
                    if (chat.conversationHistory && Array.isArray(chat.conversationHistory)) {
                        messages = chat.conversationHistory.map(msg => {
                            // Verificar se msg √© v√°lido
                            if (!msg || typeof msg !== 'object') {
                                console.warn('Mensagem inv√°lida encontrada:', msg);
                                return null;
                            }
                            
                            // Detectar formato da mensagem
                            let sender, content;
                            
                            if (msg.role) {
                                // Formato Gemini API: {role: 'user', parts: [{text: '...'}]}
                                sender = msg.role === 'user' ? 'user' : 'assistant';
                                content = msg.parts?.[0]?.text || '';
                            } else if (msg.sender) {
                                // Formato j√° convertido: {sender: 'user', content: '...'}
                                sender = msg.sender;
                                content = msg.content || '';
                            } else {
                                // Formato desconhecido, tentar extrair
                                sender = 'user';
                                content = msg.text || msg.message || String(msg);
                            }
                            
                            return {
                                sender: sender,
                                content: String(content || ''),
                                files: Array.isArray(msg.files) ? msg.files : []
                            };
                        }).filter(msg => msg !== null); // Remover mensagens inv√°lidas
                    } else if (chat.messages && Array.isArray(chat.messages)) {
                        // Formato alternativo com propriedade 'messages'
                        messages = chat.messages.map(msg => ({
                            sender: msg.sender || 'user',
                            content: String(msg.content || msg.text || ''),
                            files: Array.isArray(msg.files) ? msg.files : []
                        }));
                    }

                    const chatData = {
                        id: chat.id || `migrated_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        title: chat.title || 'Conversa Migrada',
                        model: 'gemini-pro',
                        messages: messages
                    };

                    console.log('Dados da conversa para migra√ß√£o:', chatData);
                    console.log('Mensagens extra√≠das:', messages.length, messages.slice(0, 2));

                    const response = await fetch(`${serverUrl}/api/chats`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(chatData)
                    });

                    const responseText = await response.text();
                    console.log('Resposta do servidor:', response.status, responseText);

                    if (response.ok) {
                        migrated++;
                        console.log(`‚úÖ Conversa migrada: ${chat.title}`);
                    } else {
                        errors++;
                        console.error(`‚ùå Erro ao migrar ${chat.title}:`, response.status, responseText);
                    }
                } catch (error) {
                    errors++;
                    console.error(`‚ùå Erro ao migrar conversa:`, error);
                }
            }

            if (errors === 0) {
                showStatus('migrationStatus', `‚úÖ Migra√ß√£o conclu√≠da! ${migrated} conversas migradas com sucesso.`, 'success');
            } else {
                showStatus('migrationStatus', `‚ö†Ô∏è Migra√ß√£o parcial: ${migrated} sucessos, ${errors} erros.`, 'error');
            }

            // Atualizar lista do banco
            await loadDatabaseChats();
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
        }

        // Verificar automaticamente ao carregar
        window.addEventListener('load', () => {
            checkLocalStorage();
            loadDatabaseChats();
        });

        async function importFromTxt() {
            const txtContent = document.getElementById('txtContent').value.trim();
            const chatTitle = document.getElementById('chatTitle').value.trim() || 'Conversa Importada';
            
            if (!txtContent) {
                alert('Por favor, cole o conte√∫do da conversa.');
                return;
            }

            // Verificar tamanho do texto
            const textSize = txtContent.length;
            const textSizeMB = (textSize / (1024 * 1024)).toFixed(2);
            
            if (textSize > 1 * 1024 * 1024) { // 1MB
                const useChunks = confirm(`‚ö†Ô∏è Texto longo detectado (${textSizeMB}MB)!\n\nPara evitar erros de codifica√ß√£o, recomendamos usar "Importar em Partes".\n\nClique OK para usar importa√ß√£o em partes, ou Cancelar para tentar completa.`);
                if (useChunks) {
                    // Chamar fun√ß√£o de importa√ß√£o em partes diretamente
                    importFromTxtInChunks();
                    return;
                }
            }

            try {
                // Parsear o conte√∫do TXT
                const messages = parseTxtContent(txtContent);
                
                if (messages.length === 0) {
                    alert('Nenhuma mensagem v√°lida encontrada no texto.');
                    return;
                }

                console.log(`Importando conversa: ${chatTitle}`);
                console.log(`Mensagens extra√≠das: ${messages.length}`, messages.slice(0, 2));

                // Criar dados da conversa
                const chatData = {
                    id: `imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    title: chatTitle,
                    model: 'gemini-pro',
                    messages: messages
                };

                // Enviar para o servidor
                const response = await fetch(`${serverUrl}/api/chats`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(chatData)
                });

                const responseText = await response.text();
                console.log('Resposta do servidor:', response.status, responseText);

                if (response.ok) {
                    alert(`‚úÖ Conversa "${chatTitle}" importada com sucesso!\n${messages.length} mensagens salvas.`);
                    document.getElementById('txtContent').value = '';
                    document.getElementById('chatTitle').value = '';
                    await loadDatabaseChats(); // Atualizar lista
                } else {
                    let errorMsg = `‚ùå Erro ao importar conversa: ${response.status}`;
                    
                    // Tentar extrair mensagem de erro espec√≠fica
                    try {
                        const errorData = JSON.parse(responseText);
                        if (errorData.error) {
                            errorMsg += `\n\nDetalhes: ${errorData.error}`;
                        }
                    } catch (e) {
                        // Se n√£o conseguir parsear, usar resposta raw
                        if (responseText) {
                            errorMsg += `\n\nResposta: ${responseText.substring(0, 200)}`;
                        }
                    }
                    
                    // Sugest√µes para textos longos
                    if (response.status === 500) {
                        errorMsg += `\n\nüí° Dicas para textos longos:`;
                        errorMsg += `\n‚Ä¢ Divida em conversas menores`;
                        errorMsg += `\n‚Ä¢ Remova partes desnecess√°rias`;
                        errorMsg += `\n‚Ä¢ Verifique se h√° caracteres especiais`;
                    }
                    
                    alert(errorMsg);
                    console.error('Erro completo:', responseText);
                }

            } catch (error) {
                console.error('Erro ao importar conversa:', error);
                alert(`‚ùå Erro ao processar conversa: ${error.message}`);
            }
        }

        function parseTxtContent(content) {
            const messages = [];
            const lines = content.split('\n').map(line => line.trim()).filter(line => line);
            
            // Verificar se √© formato com prefixos (User:, Assistant:)
            const hasPrefix = lines.some(line => 
                line.toLowerCase().startsWith('user:') || 
                line.toLowerCase().startsWith('usu√°rio:') ||
                line.toLowerCase().startsWith('assistant:') || 
                line.toLowerCase().startsWith('gemini:') || 
                line.toLowerCase().startsWith('ai:')
            );

            if (hasPrefix) {
                // Formato original com prefixos
                return parsePrefixedFormat(lines);
            } else {
                // Formato alternado (Gemini, Emoji, User, Emoji...)
                return parseAlternatingFormat(lines);
            }
        }

        function parsePrefixedFormat(lines) {
            const messages = [];
            let currentSender = null;
            let currentContent = '';

            for (const line of lines) {
                // Detectar in√≠cio de nova mensagem
                if (line.toLowerCase().startsWith('user:') || line.toLowerCase().startsWith('usu√°rio:')) {
                    // Salvar mensagem anterior se existir
                    if (currentSender && currentContent.trim()) {
                        messages.push({
                            sender: currentSender,
                            content: currentContent.trim(),
                            files: []
                        });
                    }
                    
                    currentSender = 'user';
                    currentContent = line.substring(line.indexOf(':') + 1).trim();
                    
                } else if (line.toLowerCase().startsWith('assistant:') || line.toLowerCase().startsWith('gemini:') || line.toLowerCase().startsWith('ai:')) {
                    // Salvar mensagem anterior se existir
                    if (currentSender && currentContent.trim()) {
                        messages.push({
                            sender: currentSender,
                            content: currentContent.trim(),
                            files: []
                        });
                    }
                    
                    currentSender = 'assistant';
                    currentContent = line.substring(line.indexOf(':') + 1).trim();
                    
                } else if (currentSender) {
                    // Continuar conte√∫do da mensagem atual
                    currentContent += '\n' + line;
                }
            }

            // Salvar √∫ltima mensagem
            if (currentSender && currentContent.trim()) {
                messages.push({
                    sender: currentSender,
                    content: currentContent.trim(),
                    files: []
                });
            }

            return messages;
        }

        function parseAlternatingFormat(lines) {
            const messages = [];
            
            // Filtrar linhas vazias
            const allLines = lines.filter(line => line.length > 0);
            
            console.log('Todas as linhas:', allLines);
            
            let currentSender = null;
            let currentContent = '';
            
            for (let i = 0; i < allLines.length; i++) {
                const line = allLines[i].trim();
                
                // Detectar separadores de texto
                if (line.toLowerCase() === 'gemini' || line.toLowerCase() === 'assistant') {
                    // Salvar mensagem anterior se existir
                    if (currentSender && currentContent.trim()) {
                        messages.push({
                            sender: currentSender,
                            content: currentContent.trim(),
                            files: []
                        });
                    }
                    
                    currentSender = 'assistant';
                    currentContent = '';
                    
                } else if (line.toLowerCase() === 'eu' || line.toLowerCase() === 'user' || line.toLowerCase() === 'usu√°rio') {
                    // Salvar mensagem anterior se existir
                    if (currentSender && currentContent.trim()) {
                        messages.push({
                            sender: currentSender,
                            content: currentContent.trim(),
                            files: []
                        });
                    }
                    
                    currentSender = 'user';
                    currentContent = '';
                    
                } else if (currentSender) {
                    // Conte√∫do da mensagem
                    if (currentContent) {
                        currentContent += '\n' + line;
                    } else {
                        currentContent = line;
                    }
                }
            }
            
            // Salvar √∫ltima mensagem se existir
            if (currentSender && currentContent.trim()) {
                messages.push({
                    sender: currentSender,
                    content: currentContent.trim(),
                    files: []
                });
            }
            
            console.log(`Formato com separadores de texto detectado: ${messages.length} mensagens processadas`);
            return messages;
        }

        async function importFromTxtInChunks() {
            const txtContent = document.getElementById('txtContent').value.trim();
            const chatTitle = document.getElementById('chatTitle').value.trim() || 'Conversa Importada';
            
            if (!txtContent) {
                alert('Por favor, cole o conte√∫do da conversa.');
                return;
            }

            try {
                // Parsear o conte√∫do TXT
                const allMessages = parseTxtContent(txtContent);
                
                if (allMessages.length === 0) {
                    alert('Nenhuma mensagem v√°lida encontrada no texto.');
                    return;
                }

                // Definir tamanho do chunk (50 mensagens por parte)
                const chunkSize = 50;
                const totalChunks = Math.ceil(allMessages.length / chunkSize);
                
                const proceed = confirm(`üì¶ Importa√ß√£o em Partes\n\nTotal de mensagens: ${allMessages.length}\nSer√° dividido em: ${totalChunks} partes\nCada parte: ~${chunkSize} mensagens\n\nDeseja continuar?`);
                if (!proceed) return;

                let successCount = 0;
                let errorCount = 0;

                // Processar cada chunk
                for (let i = 0; i < totalChunks; i++) {
                    const startIndex = i * chunkSize;
                    const endIndex = Math.min(startIndex + chunkSize, allMessages.length);
                    const chunkMessages = allMessages.slice(startIndex, endIndex);
                    
                    const chunkTitle = totalChunks > 1 ? `${chatTitle} - Parte ${i + 1}` : chatTitle;
                    
                    console.log(`Processando parte ${i + 1}/${totalChunks}: ${chunkMessages.length} mensagens`);
                    
                    try {
                        // Criar dados da conversa
                        const chatData = {
                            id: `imported_${Date.now()}_${i}_${Math.random().toString(36).substr(2, 9)}`,
                            title: chunkTitle,
                            model: 'gemini-pro',
                            messages: chunkMessages
                        };

                        // Enviar para o servidor
                        const response = await fetch(`${serverUrl}/api/chats`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(chatData)
                        });

                        if (response.ok) {
                            successCount++;
                            console.log(`‚úÖ Parte ${i + 1} importada com sucesso`);
                        } else {
                            errorCount++;
                            console.error(`‚ùå Erro na parte ${i + 1}:`, response.status);
                        }

                        // Pequena pausa entre chunks para n√£o sobrecarregar
                        if (i < totalChunks - 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }

                    } catch (error) {
                        errorCount++;
                        console.error(`‚ùå Erro ao processar parte ${i + 1}:`, error);
                    }
                }

                // Resultado final
                if (errorCount === 0) {
                    alert(`‚úÖ Importa√ß√£o em partes conclu√≠da!\n\n${successCount} partes importadas com sucesso\nTotal de mensagens: ${allMessages.length}`);
                } else {
                    alert(`‚ö†Ô∏è Importa√ß√£o parcial:\n\n‚úÖ Sucessos: ${successCount} partes\n‚ùå Erros: ${errorCount} partes\n\nVerifique o console para detalhes.`);
                }

                document.getElementById('txtContent').value = '';
                document.getElementById('chatTitle').value = '';
                await loadDatabaseChats(); // Atualizar lista

            } catch (error) {
                console.error('Erro ao importar em partes:', error);
                alert(`‚ùå Erro ao processar conversa: ${error.message}`);
            }
        }
    </script>
</body>
</html>
